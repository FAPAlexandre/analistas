<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Performance | BI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-graph { transition: transform 0.2s; border-radius: 12px; overflow: hidden; }
        .card-graph:hover { transform: translateY(-3px); }
        .chart-container::-webkit-scrollbar { height: 8px; }
        .chart-container::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        .btn-group .btn { padding: 0.5rem 1.5rem; }
        
        /* Estilo para o Term√¥metro */
        .progress-meta { height: 28px; border-radius: 14px; background-color: #e9ecef; box-shadow: inset 0 1px 3px rgba(0,0,0,.1); }
        .progress-bar-meta { font-weight: bold; font-size: 0.9rem; line-height: 28px; transition: width 1.5s cubic-bezier(0.1, 0, 0.3, 1); }

        /* REGRAS DE IMPRESS√ÉO (PDF) */
        @media print {
            .btn-group, .btn-success, .btn-dark, .card-footer, .text-muted, .badge, .no-print {
                display: none !important;
            }
            body { background-color: white !important; padding: 0 !important; }
            .container { width: 100% !important; max-width: 100% !important; }
            .card { border: 1px solid #eee !important; box-shadow: none !important; margin-bottom: 20px !important; break-inside: avoid; }
            .chart-container { overflow: visible !important; }
            canvas { width: 100% !important; height: auto !important; }
            h1 { font-size: 22pt; }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <div>
                <h1 class="fw-bold mb-0 text-dark">üìà Intelig√™ncia Mensal</h1>
                <p class="text-muted">Acompanhamento di√°rio detalhado por analista</p>
            </div>
            <div class="d-flex gap-2">
                <div class="btn-group shadow-sm">
                    <a href="{% url 'dashboard' %}" class="btn btn-white border bg-white">üè† In√≠cio</a>
                    <a href="{% url 'cadastro' %}" class="btn btn-white border bg-white">‚öôÔ∏è Lan√ßar</a>
                </div>
                <a href="{% url 'relatorio_geral' %}" class="btn btn-success shadow-sm">üìÑ Relat√≥rios</a>
                <button onclick="window.print()" class="btn btn-dark shadow-sm">üñ®Ô∏è Gerar PDF</button>
            </div>
        </div>

        <div class="d-none d-print-block mb-4">
            <h1 class="fw-bold">Relat√≥rio de Performance - Consolidado</h1>
            <p>Gerado em: {% now "d/m/Y H:i" %}</p>
        </div>

        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm border-0 p-4 bg-white" style="border-radius: 15px;">
                    <div class="d-flex justify-content-between align-items-end mb-3">
                        <div>
                            <h5 class="fw-bold mb-0 text-dark text-uppercase small" style="letter-spacing: 1px;">üèÜ Progresso Meta Ouro Global</h5>
                            <p class="text-muted small mb-0">Consolidado de todas as empresas no m√™s atual</p>
                        </div>
                        <div class="text-end">
                            <span class="h3 fw-bold {% if percentual_ouro < 40 %}text-danger{% elif percentual_ouro < 80 %}text-warning{% else %}text-success{% endif %}">
                                {{ percentual_ouro }}%
                            </span>
                        </div>
                    </div>
                    
                    <div class="progress progress-meta">
                        <div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-meta
                            {% if percentual_ouro < 40 %}bg-danger 
                            {% elif percentual_ouro < 80 %}bg-warning 
                            {% else %}bg-success{% endif %}" 
                            role="progressbar" 
                            style="width: {{ percentual_ouro }}%;" 
                            aria-valuenow="{{ percentual_ouro }}" aria-valuemin="0" aria-valuemax="100">
                            {% if percentual_ouro > 5 %}{{ percentual_ouro }}%{% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3 small text-muted">
                        <div class="bg-light p-2 rounded px-3 border">Realizado: <strong class="text-dark">R$ {{ total_geral|floatformat:2 }}</strong></div>
                        <div class="bg-light p-2 rounded px-3 border">Objetivo Ouro: <strong class="text-dark">R$ {{ meta_ouro_geral|floatformat:2 }}</strong></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            {% for item in dados %}
            <div class="col-lg-12"> 
                <div class="card shadow-sm border-0 card-graph">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-uppercase text-muted small fw-bold">Performance de Arrecada√ß√£o</span>
                            <h5 class="mb-0 fw-bold text-primary">üè¢ {{ item.empresa.nome }}</h5>
                        </div>
                        <div class="text-end no-print">
                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2">Monitoramento Ativo</span>
                        </div>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="chart-container" style="width: 100%; overflow-x: auto;">
                            <div style="min-width: 800px; height: 450px;"> 
                                <canvas id="grafico{{ item.empresa.id }}"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light text-muted small py-3 d-flex justify-content-between align-items-center">
                        <span><i class="opacity-75">Dica: Passe o mouse ou toque nas barras para ver os valores individuais.</i></span>
                        <span class="fw-bold text-dark opacity-50">Eixo X: Per√≠odo Di√°rio</span>
                    </div>
                </div>
            </div>

            <script>
                (function() {
                    const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#6610f2', '#fd7e14'];
                    const ctx = document.getElementById('grafico{{ item.empresa.id }}').getContext('2d');
                    const rawDatasets = {{ item.datasets|safe }};
                    
                    const formattedDatasets = rawDatasets.map((ds, index) => ({
                        ...ds,
                        backgroundColor: colors[index % colors.length],
                        borderRadius: 4,
                        borderSkipped: false,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }));

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: {{ item.labels|safe }}, 
                            datasets: formattedDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: { duration: 2000 },
                            interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: { position: 'top', align: 'end', labels: { usePointStyle: true, pointStyle: 'circle', font: { weight: '600' } } },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                                    titleColor: '#333',
                                    bodyColor: '#666',
                                    borderColor: '#e3e6f0',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.raw);
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: true, grid: { display: false } },
                                y: { stacked: true, beginAtZero: true, ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR') } }
                            }
                        }
                    });
                })();
            </script>
            {% empty %}
            <div class="col-12 text-center py-5">
                <div class="p-5 bg-white rounded-4 shadow-sm border">
                    <h3 class="text-muted">Nenhum dado para exibir</h3>
                    <p>Realize os lan√ßamentos di√°rios para gerar a intelig√™ncia gr√°fica.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>